#!/usr/bin/env bash

source .env

OUTPUT_FILE_NAME=docker-compose.yml

# delete current docker-compose.yml file
if [ -f $OUTPUT_FILE_NAME ]; then
    rm $OUTPUT_FILE_NAME
fi

read -d '' DOCKER_COMPOSE_FILE <<-EOF
# ${ENVIRONMENT}
# This file is generated by generate-docker-compose. Do not modify.
---

"${PROJECT}_${ENVIRONMENT}_nginx":
  image: docker.it-consultis.com.cn/itc/nginx-php-fpm:0.1.3
  container_name: ${PROJECT}_${ENVIRONMENT}_nginx
  env_file: .env
  ports:
    - "${DOCKER_HOST_HTTP_PORT}:80"
  links:
    - ${PROJECT}_${ENVIRONMENT}_node
  volumes:
    - ./app:/var/www/html
    - ./.docker/environments/${ENVIRONMENT}/etc/nginx:/etc/nginx
    - ./.docker/runtime/var/log/nginx:/var/log/nginx
    - /var/cache/nginx/microcache

"${PROJECT}_${ENVIRONMENT}_node":
  image: docker.it-consultis.com.cn/itc/buildbox-php:0.5.0
  container_name: ${PROJECT}_${ENVIRONMENT}_node
  expose:
    - "3000"
  ports:
    - "4242:4242"
  links:
    - ${PROJECT}_${ENVIRONMENT}_db
  volumes:
    - .:/project
  working_dir: /project
  command: "tail -f /dev/null"
  env_file: .env
  environment:
    HOME: /home/node
    NODE_ENV: ${ENVIRONMENT}
    MONGO_HOST: ${PROJECT}_${ENVIRONMENT}_db

"${PROJECT}_${ENVIRONMENT}_db":
  image: mongo:latest
  container_name: ${PROJECT}_${ENVIRONMENT}_db
  env_file: .env
  expose:
    - "27017"

EOF
echo "$DOCKER_COMPOSE_FILE" >> $OUTPUT_FILE_NAME
printf "\n" >> $OUTPUT_FILE_NAME

echo "Generated $OUTPUT_FILE_NAME"

# vim: ts=2 sts=2 sw=2 et
